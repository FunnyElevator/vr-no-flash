(function(e){"use strict";$('<style type="text/css">'+"#nf-coaches svg { pointer-events: none; }"+"#flashPageDiv, object, .loadflash, .infoBoxCoachMap { display: none }"+'#ResEnq_0_true:after { content: " ❤"}'+".boxy-inner.nf-boxy { background: #ddd}"+"#nf-loader-prev, #nf-loader-next { margin: 20px auto; display: block; }"+"#nf-coaches svg { padding: 0 1.5em 20px; width: 800px; }"+"#nf-coaches>div { background: #fff; border-radius: 5px; margin: 10px; width:830px }"+"#nf-coaches h2 { font: bold 24px Arial; padding: 20px 10px 0 30px; margin: 0; }"+"#nf-coaches h2 span { font: normal 16px Arial; font-style: italic; color: #555; padding-left: 1em; }"+"#nf-buttons { padding: 0 10px 35px 6px; }"+"#nf-buttons span.btnGreen { float:right; }"+"</style>").appendTo("head");var t=$('script[src*="/nf.js"], script[src*="/nf.min.js"]').attr("src").replace(/nf\.(min\.)?js.*/,"");var a={A40:true,CEMT:true,CHFY:true,CM:true,CMH:true,ED:true,EDB:true,EDB12:true,EDB2:true,EDFS:true,EDILX:true,EDM:true,EDO:true,EDS:true,EFIT:true,EFIT2:true,EFITI:true,EFITIL:true,EFITL:true,EHF:true,EHFL:true,EI:true,EI2:true,EI2L:true,EIL:true,EILF:true,EIN:true,EINY:true,EIP:true,EIPT:true,EIPT2:true,ERD:true,EX:true,EXPT:true,EXPT2:true,EXY:true,IM1:true,IM2:true,IM2L:true,MC1A:true,MC2A:true,MH2A:true,MP2A:true,MP2L:true,RIC1:true,RIC2:true,TT:true,TTP2A:true,TTPS2A:true,VCM:true,VEI:true,VEM:true,VEM8:true,VEMIV:true,VIP:true,VIPB:true};var r={};e.console=e.console||{};console.log=console.log||function(){};e.loadFlash=function(){var n={};var s={};var i;var o=parseInt($("#noOfPassengers").val());var l=[];var u=[];var f=0;function c(){var e={prev:false,next:false};$.each(s,function(t,a){if(a===1){e[t.substr(0,4)]=true}});$("#nf-loader-prev").toggle(e.prev);$("#nf-loader-next").toggle(e.next)}function p(e,t){var a=parseInt($("#coachNo",e).val());if(isNaN(a)){return}["prev","next"].forEach(function(r){if(t&&t!=r){return}if($("#"+r+"CoachAvailable",e).val()==="true"&&!(s[r+a]||n[a+(r==="prev"?-1:1)]||s[r+a+(r==="prev"?-2:2)])){s[r+a]=1;var i=$("#seatMapForm").clone();i.find("#coachNo").val(a);i.ajaxSubmit({url:"Reservation_"+r+".do",success:function(e){s[r+a]=2;var t=(new DOMParser).parseFromString(e,"text/html");var n=$("#coachNo",t).val();if(n){d(t,r)}c()}})}});c()}function d(e,t){var a=$("#coachType",e).val();if(!a){console.log("no type?",e,$("#coachType",e));return}var r=$("#coachNo",e).val();var s=$("<div/>");s.attr("data-nf-coach-number",r);i.children().each(function(){if(parseInt($(this).attr("data-nf-coach-number"))>parseInt(r)){s.insertBefore(this);return false}});if(n[r]&&n[r].type){return}n[r]={$dstElem:s,number:r,type:a,title:$("input#coachDescription",e).val(),statusXML:$("input#coachXMLString",e).val()};p(e,t);g(n[r])}var v='<filter id="status-na">'+"</filter>"+'<filter id="status-free">'+"<feComponentTransfer>"+'<feFuncR type="linear" slope=".32"/>'+'<feFuncG type="linear" slope="1"/>'+'<feFuncB type="linear" slope=".32"/>'+"</feComponentTransfer>"+"</filter>"+'<filter id="status-taken">'+"<feComponentTransfer>"+'<feFuncR type="linear" slope="1"/>'+'<feFuncG type="linear" slope="0"/>'+'<feFuncB type="linear" slope="0"/>'+"</feComponentTransfer>"+"</filter>"+'<filter id="status-season">'+"<feComponentTransfer>"+'<feFuncR type="linear" slope="1"/>'+'<feFuncG type="linear" slope=".5"/>'+'<feFuncB type="linear" slope=".5"/>'+"</feComponentTransfer>"+"</filter>"+'<filter id="status-selected">'+"<feComponentTransfer>"+'<feFuncR type="linear" slope="1"/>'+'<feFuncG type="linear" slope="1"/>'+'<feFuncB type="linear" slope="0"/>'+"</feComponentTransfer>"+"</filter>";e.nfDefineCoach=function(e){r[e.type]=e.svg;h()};function h(){u=u.filter(function(e){if(r[e[0]]){e[1]();return false}else{return true}})}function g(n){var s=$("<h2/>").text("VAUNU "+n.number);s.append($("<span/>").text(n.title+" ("+n.type+")"));n.$dstElem.append(s);var i={IM1A:"IM1"};if(i[n.type]){n.type=i[n.type]}u.push([n.type,function(){m(n)}]);if(Object.keys(a).length&&!a[n.type]){alert("Vaunutyyppiä '"+n.type+"' ei löydy. :(")}if(r[n.type]){e.setTimeout(h,1)}else{$.ajaxSetup({cache:true});$.getScript(t+"coaches/"+n.type+".js");$.ajaxSetup({cache:false})}}function m(e){f++;e.svgId=f;var t=r[e.type].replace(/ width="\w+"/,"").replace(/ height="\w+"/,"").replace(/ id="(?=\w+")/g,' id="c'+e.svgId).replace(/ xlink:href="#(?=\w+")/g,' xlink:href="#c'+e.svgId);if(e.svgId===1){t=t.replace(/<defs>/,"<defs>"+v)}var a=(new DOMParser).parseFromString(t,"text/xml");var s=(new DOMParser).parseFromString(e.statusXML,"text/xml");e.statuses={};$("seat",s).each(function(){var t=$(this);var a=t.find("number").text();if(t.find("selected").text()==="1"){e.statuses[a]="selected";l.push({coach:e.number,seat:a})}else{var r=t.find("status").text();if(r==="0"){e.statuses[a]="free"}else if(r==="6"){e.statuses[a]="season"}else{if(!/^[16]$/.test(r)){console.log("UNKNOWN SEAT STATUS",e.number,a,r)}e.statuses[a]="taken"}}});function i(e){var t;while(t=e.getAttribute("xlink:href")){e=$(t)[0]}$(e).find("*").andSelf().attr("fill","#fff")}a.children[0].id="nf-svg-"+e.svgId;e.$dstElem.append(a.children[0]);e.$dstElem.find("svg").hide().fadeIn();function u(t){return Array.prototype.slice.apply(document.querySelectorAll("svg#nf-svg-"+e.svgId+" "+t))}var c=u('[class="n-floorplan"]')[0];var p=u(c.getAttribute("xlink:href"))[0];p.setAttribute("transform",c.getAttribute("transform"));c.parentNode.removeChild(c);p.parentNode.removeChild(p);u("")[0].appendChild(p);e.drawSeatStatuses=function(t){var a=t?'[class="n-seat_'+t+'"]':'[class^="n-seat_"]';u(a).forEach(function(t){i(t);$(t.getAttribute("xlink:href")).css({cursor:"pointer",pointerEvents:"all"});var a=t.className.baseVal.replace(/^n-seat_/,"");if(a in e.statuses){t.setAttribute("filter","url(#status-"+e.statuses[a]+")")}})};e.drawSeatStatuses();u('[class^="n-seat_"]').forEach(function(t){$(t).click(function(){var t=this.className.baseVal.replace(/^n-seat_/,"");if(e.statuses[t]==="free"){l.push({coach:e.number,seat:t});e.statuses[t]="selected";if(l.length>o){var a=l.shift();n[a.coach].statuses[a.seat]="free";n[a.coach].drawSeatStatuses(a.seat)}e.drawSeatStatuses(t)}})})}i=$('<div id="nf-coaches"/>');i.append($("<div/>").attr("data-nf-coach-number",999));$("#flashPageDiv").after('<img id="nf-loader-prev" src="https://shop.vr.fi/onlineshop/pages/ram/img/loadingAnimation.gif">',i,'<img id="nf-loader-next" src="https://shop.vr.fi/onlineshop/pages/ram/img/loadingAnimation.gif">','<div id="nf-buttons">'+'<span class="btnVR middle btnGreen"><a href="#">Vahvista</a></span>'+'<span class="btnVR middle btnGrey"><a href="#">Peruuta</a></span>'+"</div>");$("#flashPageDiv").closest(".boxy-inner").addClass("nf-boxy");$("#nf-buttons a:first").click(function(){var e=o-l.length;if(e){alert("Valitse vielä "+e+" paikka"+(e>1?"a":""));return}var t=l[0].coach;var a="";l.forEach(function(e){if(t!==e.coach){alert("Valitettavasti tällä virityksellä voi varata paikkoja vain yhdestä vaunusta kerrallaan.");return}a+=",seat_"+e.seat});a=a.replace(/^,/,"");$("#seatMapForm #coachNo").val(t);saveSeatReservations("./Reservation_add.do",a)});$("#nf-buttons a:last").click(function(){$("a.close").trigger("click")});d(document)}})(this);
